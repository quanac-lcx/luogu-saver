{% extends "../layout.njk" %}
{% from "../components/code_editor.njk" import codeEditor %}

{% block content %}
<div class="ui grid">
    <div class="sixteen wide column">
        <h1 class="ui header">
            <i class="ui icon bullhorn"></i>
            <div class="content">
                公告管理
                <div class="sub header">编辑主页公告内容</div>
            </div>
        </h1>
    </div>
</div>

<div class="ui grid">
    <div class="sixteen wide column">
        <div class="card shadow">
            <h3 class="ui header">
                <i class="ui icon edit colored"></i>
                编辑公告
            </h3>
            
            <form class="ui form" id="announcement-form">
                {{ codeEditor(
                    id='announcement-content',
                    name='content',
                    value=announcement.content if announcement else '',
                    language='html',
                    placeholder='输入公告内容，支持 HTML 标签',
                    rows=12,
                    label='公告内容（支持 HTML）'
                ) }}
                
                <div class="field">
                    <div class="ui checkbox">
                        <input type="checkbox" id="announcement-enabled" name="enabled" {% if announcement.enabled %}checked{% endif %}>
                        <label>启用公告</label>
                    </div>
                </div>
                
                <button type="submit" class="ui primary button">
                    <i class="ui icon save"></i>
                    保存
                </button>
                <a href="/admin" class="ui button">
                    <i class="ui icon arrow left"></i>
                    返回
                </a>
            </form>
        </div>
    </div>
    
    <div class="sixteen wide column">
        <div class="card shadow">
            <h3 class="ui header">
                <i class="ui icon eye colored"></i>
                预览
            </h3>
            <div id="announcement-preview" style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 4px; background-color: #f9f9f9;">
                {{ announcement.content | safe if announcement else "暂无公告内容" }}
            </div>
        </div>
    </div>
</div>

<script>
// 实时预览
document.getElementById('announcement-content').addEventListener('input', function() {
    document.getElementById('announcement-preview').innerHTML = this.value || '暂无公告内容';
});

// 表单提交
document.getElementById('announcement-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = document.getElementById('announcement-content').value;
    const enabled = document.getElementById('announcement-enabled').checked;
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="ui icon spinner loading"></i> 保存中...';
    submitBtn.disabled = true;
    
    $.ajax({
        url: '/admin/api/announcement',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ content, enabled }),
        success: function(res) {
            if (res.success) {
                Swal.fire('成功', '公告更新成功', 'success');
            } else {
                Swal.fire('失败', res.message || '更新失败', 'error');
            }
        },
        error: function() {
            Swal.fire('错误', '网络或服务器异常', 'error');
        },
        complete: function() {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
