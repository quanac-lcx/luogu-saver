{% extends "layout.njk" %}

{% block extra_header %}
    <script src="/static/self/js/display_utils.js"></script>
    <link rel="stylesheet" href="/static/self/css/markdown.css" />
    <link rel="stylesheet" href="/static/katex/katex.min.css">
    <script defer src="/static/katex/katex.min.js"></script>
    <script defer src="/static/katex/contrib/auto-render.min.js"></script>
    <script type="module" src="/static/self/js/render.js"></script>
    <script src="/static/self/js/request_utils.js"></script>
{% endblock %}

{% block content %}
    <input type="hidden" id="url" value="article/{{ article.id }}">
    <input type="hidden" id="markdown-content" value="{{ article.content }}">
    <div class="ui grid">
        <div class="sixteen wide column">
            <div class="card shadow outline">
                <h1 class="ui header">{{ article.title }}</h1>
                <span class="meta gray"><i class="ui icon calendar colored"></i> 最后更新于 {{ article.updated_at }}</span>
                <div class="ui grid">
                    <div class="eight wide column">
                        <div class="card shadow outline padding-15" style="height: 90%;">
                            <span class="meta gray small">作者</span>
                            <div class="meta user" style="margin-top: 5px;">
                                <img class="ui mini circular image"
                                     src="https://cdn.luogu.com.cn/upload/usericon/{{ article.author.id if article.author.id else 3 }}.png"
                                     alt="user_icon">
                                {% if empty %}
                                <a href="javascript:void(0)"
                                   class="user-Purple"
                                   style="margin-left: 5px; font-weight: 550;">未知用户</a>
                                {% else %}
                                <a href="/user/{{ article.author.id }}"
                                   class="user-{{ article.author.color }}"
                                   style="margin-left: 5px; font-weight: 550;">{{ article.author.name }}</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="eight wide column">
                        <div class="card shadow outline padding-15" style="height: 90%; display: flex; flex-direction: column;">
                            <span class="meta gray small">分类</span>
                            <span style="margin-top: 5px; display: flex; flex: 1; align-items: center; justify-content: flex-start;">
                            {% if article.category == 1 %}
                                <i class="fas fa-user" style="margin-right: 6px; color: #667eea;"></i>个人记录
                            {% elif article.category == 2 %}
                                <i class="fas fa-lightbulb" style="margin-right: 6px; color: #667eea;"></i>题解
                            {% elif article.category == 3 %}
                                <i class="fas fa-cogs" style="margin-right: 6px; color: #667eea;"></i>科技·工程
                            {% elif article.category == 4 %}
                                <i class="fas fa-brain" style="margin-right: 6px; color: #667eea;"></i>算法·理论
                            {% elif article.category == 5 %}
                                <i class="fas fa-camera" style="margin-right: 6px; color: #667eea;"></i>生活·游记
                            {% elif article.category == 6 %}
                                <i class="fas fa-graduation-cap" style="margin-right: 6px; color: #667eea;"></i>学习·文化课
                            {% elif article.category == 7 %}
                                <i class="fas fa-gamepad" style="margin-right: 6px; color: #667eea;"></i>休闲·娱乐
                            {% elif article.category == 8 %}
                                <i class="fas fa-comments" style="margin-right: 6px; color: #667eea;"></i>闲话
                            {% else %}
                                <i class="fas fa-question" style="margin-right: 6px; color: #667eea;"></i>未知分类
                            {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="sixteen wide column">
                        {% if not empty %}
                        <a href="https://www.luogu.com/article/{{ article.id }}" class="ui button">
                            <i class="ui icon share square"></i> 查看原专栏
                        </a>
                        <a href="javascript:void(0)" onclick="copyMarkdown()" class="ui button">
                            <i class="ui icon copy"></i> 复制原文
                        </a>
                        {% endif %}
                        <a href="javascript:void(0)" id="save-btn" class="ui positive button">
                            <i class="ui icon sync alternate"></i> 更新内容
                        </a>
                        {% if not empty %}
                        <a href="javascript:void(0)" id="request-deletion-btn" class="ui red button" 
                           data-is-author="{% if user and article.author and user.id == article.author.id %}true{% else %}false{% endif %}">
                            <i class="ui icon trash alternate"></i> 申请删除
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card shadow outline md-container" id="render-container" style="min-height: 200px; position: relative;">
                <div class="ui active inverted dimmer" id="render-loader">
                    <div class="ui text loader" id="loader-text">
                        等待网页内容加载完成...
                    </div>
                </div>

                <div id="render-content" class="ui transition hidden" style="display: none;">
                    {% if not empty %}
                        {{ renderedContent | safe }}
                    {% else %}
                        <div style="text-align: center; padding: 50px 0;">
                            <i class="ui icon info circle" style="font-size: 3rem; color: gray;"></i>
                            <div style="font-size: 1.5rem; color: gray; margin-top: 10px;">尚未保存内容</div>
                            <div style="margin-top: 10px;">请点击上方的“更新内容”按钮以保存专栏内容</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <script>
        setTimeout(() => {
            $('#loader-text').text('如果长时间未加载完成，请尝试 Ctrl+F5 刷新浏览器缓存。');
        }, 10000);
        
        // 申请删除功能
        document.getElementById('request-deletion-btn')?.addEventListener('click', async function() {
            const isAuthor = this.dataset.isAuthor === 'true';
            
            // 检查是否为作者
            if (!isAuthor) {
                Swal.fire({
                    title: '错误',
                    text: '未登录账户或者登录的账户与作者的不一致',
                    icon: 'error',
                    confirmButtonText: '确定'
                });
                return;
            }
            
            const result = await Swal.fire({
                title: '申请删除文章',
                html: `
                    <p style="margin-bottom: 15px; text-align: left;">请说明您申请删除此文章的理由：</p>
                    <textarea id="deletion-reason" class="swal2-textarea" placeholder="请输入删除理由（至少15个字符）" style="width: 100%; height: 120px; resize: vertical;"></textarea>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em; text-align: left;">提交后将由管理员审核，审核通过后文章将被删除。</p>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '提交申请',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545',
                preConfirm: () => {
                    const reason = document.getElementById('deletion-reason').value;
                    if (!reason || reason.trim().length < 15) {
                        Swal.showValidationMessage('删除理由至少需要15个字符');
                        return false;
                    }
                    return reason.trim();
                }
            });
            
            if (result.isConfirmed) {
                const reason = result.value;
                
                try {
                    Swal.fire({
                        title: '正在提交...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    const response = await fetch('/api/deletion-request/article/{{ article.id }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        Swal.fire({
                            title: '提交成功',
                            text: data.message || '删除申请已提交，请等待管理员审核',
                            icon: 'success',
                            confirmButtonText: '确定'
                        });
                    } else {
                        Swal.fire({
                            title: '提交失败',
                            text: data.message || '提交删除申请失败，请稍后再试',
                            icon: 'error',
                            confirmButtonText: '确定'
                        });
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire({
                        title: '提交失败',
                        text: '网络错误或服务器异常，请稍后再试',
                        icon: 'error',
                        confirmButtonText: '确定'
                    });
                }
            }
        });
    </script>
{% endblock %}