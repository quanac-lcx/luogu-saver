{% extends "layout.njk" %}

{% block content %}
    <div class="ui grid">
        <div class="sixteen wide column">
            <div class="card shadow">
                <h1 class="ui center aligned header">
                    <span><i class="ui search icon colored"></i>Token 申请</span>
                    <div class="sub header" style="margin-top: 10px;">申请在洛谷保存站的唯一识别凭据</div>
                </h1>
            </div>
        </div>
    </div>
    <div class="ui grid">
        <div class="sixteen wide column">
            <div class="card shadow outline">
                <h3 class="ui dividing header">
                    <i class="info icon"></i>
                    申请须知
                </h3>
                <ul>
                    <li>为了使用保存站的一些功能，你必须验证你的身份。</li>
                    <li>你需要用你的洛谷账号创建一个剪贴板。</li>
                    <li>剪贴板内容必须是 <code>lgs_register_verification</code>。</li>
                    <li>创建完了，请把剪贴板 ID 粘贴过来，提交。</li>
                    <li>剪贴板 ID 是你剪贴板链接中的最后八位，例如 <code>https://www.luogu.com.cn/paste/ilovecz6</code> 的剪贴板 ID 是 <code>ilovecz6</code>。</li>
                    <li>如果你做对了，你会获得一个 Token。</li>
                    <li>重复申请 Token 的话，旧的会失效。只有新的能用。</li>
                    <li>保管好 Token。保存站只认 Token 不认人。</li>
                </ul>
            </div>
            <div class="card shadow outline">
                <div class="ui form">
                    <div class="field">
                        <label>洛谷 UID</label>
                        <input class="ui icon fluid input" type="text" id="uid" placeholder="请输入你的洛谷 UID">
                    </div>
                    <div class="field">
                        <label>剪贴板 ID</label>
                        <input class="ui icon fluid input" type="text" id="paste-id" placeholder="请输入你的剪贴板 ID">
                    </div>
                    <button id="generate-btn" class="ui primary button">
                        <i class="key icon"></i> 生成 Token
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
		$('#generate-btn').on('click', function () {
			const uid = $('#uid').val().trim();
			const pasteId = $('#paste-id').val().replaceAll('/', '').slice(-8).trim();

			if (!uid || !pasteId) {
				Swal.fire({
					icon: 'error',
					title: '输入不完整',
					text: '请填写所有字段',
				});
				return;
			}

			$.ajax({
				url: '/token/generate',
				method: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({ uid: uid, pasteId: pasteId }),
				success: function (data) {
					if (data.success) {
					    Swal.fire({
                            icon: 'success',
                            title: '申请成功',
                            html: `
                                <p>你的 Token 是：</p>
                                <div style="position: relative;">
                                    <pre id="token-text" class="firacode" style="word-break: break-all; background: #f4f4f4; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px;">${data.token}</pre>
                                    <button id="copy-token" class="ui mini icon button" style="position: absolute; top: 5px; right: 5px;" onclick="copyToken('${data.token}')">
                                        <i class="copy icon"></i>
                                    </button>
                                </div>
                                <p>请妥善保存！</p>`,
                            confirmButtonText: '好的喵！',
                            didRender: () => {
                                document.getElementById('copy-token').addEventListener('click', function(e) {
                                    e.preventDefault();
                                    navigator.clipboard.writeText(data.token).then(() => {
                                        const originalHtml = this.innerHTML;
                                        this.innerHTML = '<i class="check icon"></i>';
                                        setTimeout(() => {
                                            this.innerHTML = originalHtml;
                                        }, 1500);
                                    });
                                });
                            }
                        });
					} else {
						Swal.fire({
							icon: 'error',
							title: '申请失败',
							text: data.message || '未知错误'
						});
					}
				},
				error: function () {
					Swal.fire({
						icon: 'error',
						title: '网络错误',
						text: '请稍后再试。'
					});
				}
			});
		});
    </script>
{% endblock %}
