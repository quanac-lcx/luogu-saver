{% extends "../layout.njk" %}
{% from "../components/code_editor.njk" import codeEditor %}

{% block content %}
<div class="ui grid">
    <div class="sixteen wide column">
        <h1 class="ui header">
            <i class="ui icon flag"></i>
            <div class="content">
                Banner 管理
                <div class="sub header">管理页面顶部的 Banner 横幅</div>
            </div>
        </h1>
    </div>
</div>

<div class="ui grid">
    <div class="sixteen wide column">
        <div class="card shadow">
            <h3 class="ui header">
                <i class="ui icon edit colored"></i>
                编辑 Banners
            </h3>
            <div style="margin-bottom: 20px;">
                <button class="ui primary button" onclick="addBanner()">
                    <i class="ui icon plus"></i>
                    添加 Banner
                </button>
                <a href="/admin" class="ui button">
                    <i class="ui icon arrow left"></i>
                    返回
                </a>
            </div>
            
            <form class="ui form" id="banners-form">
                <div id="banners-container">
                    {% if banners and banners.length > 0 %}
                        {% for banner in banners %}
                        <div class="banner-item" data-index="{{ loop.index0 }}" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative;">
                            <button type="button" class="ui red icon button" onclick="removeBanner({{ loop.index0 }})" style="position: absolute; top: 10px; right: 10px;">
                                <i class="trash icon"></i>
                            </button>
                            <div class="eight wide field">
                                <label>Banner 内容（支持 HTML）</label>
                                <textarea name="content-{{ loop.index0 }}" rows="3" placeholder="输入 Banner 内容，支持 HTML 标签" class="banner-content">{{ banner.content }}</textarea>
                            </div>
                            <div class="fields">
                                <div class="five wide field">
                                    <label>背景颜色</label>
                                    <input type="text" name="color-{{ loop.index0 }}" value="{{ banner.color or '#667eea' }}" placeholder="#667eea" class="banner-color">
                                </div>
                                <div class="three wide field">
                                    <div class="ui checkbox" style="margin-top: 32px;">
                                        <input type="checkbox" name="enabled-{{ loop.index0 }}" {% if banner.enabled %}checked{% endif %} class="banner-enabled">
                                        <label>启用此 Banner</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: gray; padding: 20px;">暂无 Banner，点击上方"添加 Banner"按钮创建</p>
                    {% endif %}
                </div>
                
                <button type="submit" class="ui primary button" style="margin-top: 20px;">
                    <i class="ui icon save"></i>
                    保存所有更改
                </button>
            </form>
        </div>
    </div>
    
    <div class="sixteen wide column">
        <div class="card shadow">
            <h3 class="ui header">
                <i class="ui icon eye colored"></i>
                预览
            </h3>
            <div id="banners-preview" style="padding: 15px;">
                <!-- 预览区域 -->
            </div>
        </div>
    </div>
</div>

<script>
let bannerCount = {{ banners.length if banners else 0 }};

function addBanner() {
    const container = document.getElementById('banners-container');

    const emptyMessage = container.querySelector('p');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    const bannerItem = document.createElement('div');
    bannerItem.className = 'banner-item';
    bannerItem.setAttribute('data-index', bannerCount);
    bannerItem.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative;';
    
    bannerItem.innerHTML = `
        <button type="button" class="ui red icon button" onclick="removeBanner(${bannerCount})" style="position: absolute; top: 10px; right: 10px;">
            <i class="trash icon"></i>
        </button>

        <div class="eight wide field">
            <label>Banner 内容（支持 HTML）</label>
            <textarea name="content-${bannerCount}" rows="3" placeholder="输入 Banner 内容，支持 HTML 标签" class="banner-content"></textarea>
        </div>

        <div class="fields">
            <div class="eight wide field">
                <label>背景颜色</label>
                <input type="text" name="color-${bannerCount}" value="#667eea" placeholder="#667eea" class="banner-color">
            </div>
            <div class="eight wide field">
                <div class="ui checkbox" style="margin-top: 32px;">
                    <input type="checkbox" name="enabled-${bannerCount}" checked class="banner-enabled">
                    <label>启用此 Banner</label>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(bannerItem);
    bannerCount++;
    
    // 初始化 checkbox
    $('.ui.checkbox', bannerItem).checkbox();
    updatePreview();
}

function removeBanner(index) {
    const bannerItem = document.querySelector(`.banner-item[data-index="${index}"]`);
    if (bannerItem) {
        bannerItem.remove();
        updatePreview();
        
        // 如果没有 banner 了，显示提示信息
        const container = document.getElementById('banners-container');
        if (container.children.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: gray; padding: 20px;">暂无 Banner，点击上方"添加 Banner"按钮创建</p>';
        }
    }
}

function updatePreview() {
    const previewDiv = document.getElementById('banners-preview');
    const bannerItems = document.querySelectorAll('.banner-item');
    
    previewDiv.innerHTML = '';
    
    bannerItems.forEach((item) => {
        const content = item.querySelector('.banner-content').value;
        const color = item.querySelector('.banner-color').value;
        const enabled = item.querySelector('.banner-enabled').checked;
        
        if (enabled && content) {
            const bannerDiv = document.createElement('div');
            bannerDiv.style.cssText = `
                background-color: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                margin-bottom: 10px;
                position: relative;
                padding-right: 50px;
            `;
            bannerDiv.innerHTML = content + '<button style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: black; cursor: pointer; font-size: 18px;">×</button>';
            previewDiv.appendChild(bannerDiv);
        }
    });
    
    if (previewDiv.children.length === 0) {
        previewDiv.innerHTML = '<p style="text-align: center; color: gray;">暂无启用的 Banner</p>';
    }
}

// 监听输入变化以更新预览
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('banner-content') || 
        e.target.classList.contains('banner-color')) {
        updatePreview();
    }
});

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('banner-enabled')) {
        updatePreview();
    }
});

document.getElementById('banners-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const bannerItems = document.querySelectorAll('.banner-item');
    const banners = [];
    
    bannerItems.forEach((item) => {
        const content = item.querySelector('.banner-content').value;
        const color = item.querySelector('.banner-color').value;
        const enabled = item.querySelector('.banner-enabled').checked;
        
        banners.push({
            content: content,
            color: color || '#667eea',
            enabled: enabled
        });
    });
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="ui icon spinner loading"></i> 保存中...';
    submitBtn.disabled = true;
    
    $.ajax({
        url: '/admin/api/banners',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ banners }),
        success: function(res) {
            if (res.success) {
                Swal.fire('成功', 'Banners 更新成功', 'success');
            } else {
                Swal.fire('失败', res.message || '更新失败', 'error');
            }
        },
        error: function() {
            Swal.fire('错误', '网络或服务器异常', 'error');
        },
        complete: function() {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
});

$(function() {
    $('.ui.checkbox').checkbox();
    updatePreview();
});
</script>
{% endblock %}
